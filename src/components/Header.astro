---
import { getLangFromUrl, getLocalizedPath, type Lang } from '../i18n/utils';
import MobileMenu from './MobileMenu';
import ThemeToggle from './ThemeToggle.astro';

const lang = getLangFromUrl(Astro.url) as Lang;
const altLang = lang === 'ja' ? 'en' : 'ja';

const navItems = [
  { href: getLocalizedPath('/', lang), label: 'Home' },
  { href: getLocalizedPath('/blog', lang), label: 'Blog' },
];

const contactHref = getLocalizedPath('/contact', lang);
const currentPath = Astro.url.pathname;
const homePath = getLocalizedPath('/', lang);

const isActive = (href: string) => {
  if (href === homePath) {
    return currentPath === href || currentPath === href.slice(0, -1);
  }
  return currentPath.startsWith(href);
};

// Prepare nav items with isActive flag for React component
const navItemsWithActive = navItems.map((item) => ({
  ...item,
  isActive: isActive(item.href),
}));

// Language paths - preserve current path when switching
const altLangPath = getLocalizedPath(currentPath, altLang);
---

<header class="glass fixed left-0 right-0 top-0 z-50">
  <nav class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
    <div class="flex h-16 items-center justify-between">
      <!-- Logo -->
      <!-- TODO: Update with your site name -->
      <a href={getLocalizedPath('/', lang)} class="flex items-center gap-2">
        <img src="/favicon.svg" alt="Site Logo" class="h-8 w-8 invert dark:invert-0" />
        <span class="text-xl font-bold text-slate-800 dark:text-white">Site Name</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden items-center space-x-8 md:flex">
        {
          navItems.map((item) => (
            <a
              href={item.href}
              class:list={[
                'text-sm font-medium transition-colors',
                isActive(item.href)
                  ? 'text-blue-500'
                  : 'text-slate-600 hover:text-blue-500 dark:text-slate-300 dark:hover:text-blue-400',
              ]}
            >
              {item.label}
            </a>
          ))
        }
        <a href={contactHref} class="btn-primary px-5 py-2 text-sm">Contact</a>
        <!-- Desktop Language Switcher -->
        <div class="flex items-center space-x-2">
          <span class="rounded-full bg-blue-100 px-3 py-1 text-sm font-medium text-blue-600 dark:bg-blue-900 dark:text-blue-300">
            {lang.toUpperCase()}
          </span>
          <a
            href={altLangPath}
            class="rounded-full px-3 py-1 text-sm font-medium text-slate-500 transition-colors hover:bg-slate-100 hover:text-blue-500 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-blue-400"
          >
            {altLang.toUpperCase()}
          </a>
        </div>
        <!-- Theme Toggle -->
        <ThemeToggle />
      </div>

      <!-- Mobile Menu (React Component) -->
      <MobileMenu
        client:load
        navItems={navItemsWithActive}
        contactHref={contactHref}
        contactLabel="Contact"
        currentLang={lang}
        altLang={altLang}
        altLangPath={altLangPath}
      />
    </div>
  </nav>
</header>
