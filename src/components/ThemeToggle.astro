---
import { Icon } from 'astro-icon/components';
---

<button
  id="theme-toggle"
  class="rounded-full p-2 text-slate-500 transition-all duration-300 hover:bg-blue-100 hover:text-blue-500 dark:text-slate-400 dark:hover:bg-blue-900 dark:hover:text-blue-400"
  aria-label="Toggle theme"
  title="Toggle theme (Light/Dark/System)"
>
  <!-- Sun icon - shown when theme is 'light' -->
  <Icon name="lucide:sun" class="theme-icon theme-icon-light h-5 w-5" />
  <!-- Moon icon - shown when theme is 'dark' -->
  <Icon name="lucide:moon" class="theme-icon theme-icon-dark hidden h-5 w-5" />
  <!-- Monitor icon - shown when theme is 'system' -->
  <Icon name="lucide:monitor" class="theme-icon theme-icon-system hidden h-5 w-5" />
</button>

<style>
  .theme-icon {
    display: none;
  }

  /* Default: show sun icon */
  #theme-toggle .theme-icon-light {
    display: block;
  }

  /* When data-theme is set, use that */
  #theme-toggle[data-theme='light'] .theme-icon-light {
    display: block;
  }
  #theme-toggle[data-theme='light'] .theme-icon-dark,
  #theme-toggle[data-theme='light'] .theme-icon-system {
    display: none;
  }

  #theme-toggle[data-theme='dark'] .theme-icon-dark {
    display: block;
  }
  #theme-toggle[data-theme='dark'] .theme-icon-light,
  #theme-toggle[data-theme='dark'] .theme-icon-system {
    display: none;
  }

  #theme-toggle[data-theme='system'] .theme-icon-system {
    display: block;
  }
  #theme-toggle[data-theme='system'] .theme-icon-light,
  #theme-toggle[data-theme='system'] .theme-icon-dark {
    display: none;
  }
</style>

<script>
  function initThemeToggle() {
    const toggle = document.getElementById('theme-toggle');
    if (!toggle) return;

    // Remove old listeners by cloning
    const newToggle = toggle.cloneNode(true) as HTMLElement;
    toggle.parentNode?.replaceChild(newToggle, toggle);

    const themes = ['light', 'dark', 'system'] as const;
    type Theme = (typeof themes)[number];

    function getStoredTheme(): Theme {
      const stored = localStorage.getItem('theme');
      if (stored === 'light' || stored === 'dark' || stored === 'system') {
        return stored;
      }
      return 'system';
    }

    function setTheme(theme: Theme) {
      localStorage.setItem('theme', theme);
      applyTheme(theme);
      updateIcon(theme);
    }

    function applyTheme(theme: Theme) {
      const isDark =
        theme === 'dark' ||
        (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);

      if (isDark) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    }

    function updateIcon(theme: Theme) {
      const btn = document.getElementById('theme-toggle');
      if (!btn) return;

      // Use data attribute to control icon visibility
      btn.setAttribute('data-theme', theme);
    }

    // Click handler - cycle through themes
    newToggle.addEventListener('click', () => {
      const current = getStoredTheme();
      const currentIndex = themes.indexOf(current);
      const nextIndex = (currentIndex + 1) % themes.length;
      const next = themes[nextIndex];
      setTheme(next);
    });

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (getStoredTheme() === 'system') {
        applyTheme('system');
      }
    });

    // Initialize icon state
    updateIcon(getStoredTheme());
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initThemeToggle);
  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initThemeToggle);
</script>
